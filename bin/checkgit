#!/usr/bin/env bash

die(){
  echo "$1"
  exit 1
}

protected_branch="${1:-master}"
allow_uncommitted="${2:+yes}"

is_destructive='force|delete|\-f|\+'
current_branch="$(git symbolic-ref HEAD | sed -e 's,.*/\(.*\),\1,')"
push_command="$(ps -ocommand= -p $PPID)"

if [[ "$push_command" =~ "$is_destructive" ]] && [ "$current_branch" = "$protected_branch" ]; then
  die "ERROR: Cannot force push or delete $protected_branch branch"
fi

if [[ "$push_command" =~ "$is_destructive" ]] && [[ "$push_command" =~ "$protected_branch" ]]; then
  die "ERROR: Cannot force push or delete $protected_branch branch"
fi

will_remove_protected_branch=":$protected_branch"

if [[ "$push_command" =~ "$will_remove_protected_branch" ]]; then
  die "ERROR: Cannot remove $protected_branch branch"
fi

has_uncommitted_changes="$(git status --porcelain | grep .)"

if [[ -z "$allow_uncommitted" && -n "$has_uncommitted_changes" ]]; then
  echo "$has_uncommitted_changes"
  die "ERROR: Cannot push with uncommited changes!"
fi

exit 0